<form id="uploadForm" enctype="multipart/form-data">

    <div class="import-csv">
        <label>
            Import d'un fichier CSV&nbsp;
            <input type="file" id="csvFile" name="file" accept=".csv" required>

        </label>
    </div>
    <div>
        <button type="submit" id="importQ">Importer des questions CSV</button>
    </div>
    <div class="not-yet" style="display:none">
        <div>
            <label>
                <input type="checkbox" id="fixSubjects" name="fix_subjects" checked>
                Corriger les sujets similaires
            </label>
        </div>
        <div>
            <label for="subjectThreshold">Seuil de similarité:</label>
            <input type="number" id="subjectThreshold" name="subject_threshold" min="0" max="1" step="0.05" value="0.9">
            <small>(0.0 à 1.0, défaut: 0.9)</small>
        </div>
    </div>

    <div id="message"></div>
    <div id="details"></div>
</form>

<script>
    const form = document.getElementById('uploadForm');
    const messageDiv = document.getElementById('message');
    const detailsDiv = document.getElementById('details');

    let resetTimeout = null;

    function refreshParentTable() {
        if (window.tableManager && typeof window.tableManager.loadQuestions === 'function') {
            window.tableManager.loadQuestions();
            return;
        }
    }

    function refreshAndResetMessages() {
        messageDiv.innerHTML = '';
        detailsDiv.innerHTML = '';
        this.refreshParentTable()
    }

    function scheduleReset(delay = 5000) {
        if (resetTimeout) {
            clearTimeout(resetTimeout);
        }
        resetTimeout = setTimeout(refreshAndResetMessages, delay);
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Annuler tout reset en cours
        if (resetTimeout) {
            clearTimeout(resetTimeout);
            resetTimeout = null;
        }

        messageDiv.innerHTML = '<p>Import en cours...</p>';
        detailsDiv.innerHTML = '';
        const formData = new FormData();
        const fileInput = document.getElementById('csvFile');
        const fixSubjects = document.getElementById('fixSubjects').checked || true;
        const threshold = document.getElementById('subjectThreshold').value || 0.9;
        formData.append('file', fileInput.files[0]);

        // Récupérer la config au moment du submit
        const token = window.APP_CONFIG?.token || '{{ token }}';
        const apiUrl = window.APP_CONFIG?.apiUrl || 'http://localhost:8000/api';

        try {
            const response = await fetch(`${apiUrl}/questions/from_csv?fix_subjects=${fixSubjects}&subject_threshold=${threshold}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            let result;
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                result = await response.json();
            } else {
                const text = await response.text();
                result = { detail: `Erreur serveur: ${text.substring(0, 200)}` };
            }

            if (response.ok) {
                messageDiv.innerHTML = `<p class="success">${result.message}</p>`;
                if (result.error_details && result.error_details.length > 0) {
                    let errorsHtml = '<p class="error">Détails des erreurs:';
                    result.error_details.forEach(err => {
                        errorsHtml += `<span>${err.question}: ${err.error}</span>`;
                    });
                    errorsHtml += '</p><p>Vous pouvez recharger la liste</p>';
                    detailsDiv.innerHTML = errorsHtml;
                }
                form.reset();
                document.getElementById('subjectThreshold').value = '0.9';

                // Rafraîchir le tableau parent immédiatement après succès
                refreshParentTable();

                // Programmer la réinitialisation des messages après 5 secondes
                scheduleReset(5000);
            } else {
                messageDiv.innerHTML = `
                    <p class="error">Erreur</p>
                    <p>${result.detail || 'Erreur lors de l\'import'}</p>
                    <p>Merci de recharger la liste</p>
                `;

                // Programmer la réinitialisation après 5 secondes
                scheduleReset(5000);
            }
        } catch (error) {
            messageDiv.innerHTML = `
                <p class="error">Erreur</p>
                <p>Erreur de connexion: ${error.message}</p>
                <p>Merci de recharger la liste</p>
            `;

            // Programmer la réinitialisation après 5 secondes
            scheduleReset(5000);
        }
    });
</script>